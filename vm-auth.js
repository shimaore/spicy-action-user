// Generated by CoffeeScript 1.12.7
(function() {
  var PouchDB, crypto, debug, hex_hmac_sha1, jsonBody, seem;

  seem = require('seem');

  PouchDB = require('pouchdb-core').plugin(require('pouchdb-adapter-http'));

  jsonBody = (require('body-parser')).json({});

  this.name = (require('./package')).name + ":vm-auth";

  debug = (require('debug'))(this.name);

  this.include = function() {
    return this.post('/vm-auth', jsonBody, seem(function*() {
      var db_uri, new_number, number, number_data, number_domain, pin, ref, user_database, user_id, vm_db, vm_settings;
      if (this.session.couchdb_token != null) {
        this.res.status(400);
        this.json({
          error: 'Already authenticated'
        });
        return;
      }
      ref = this.body, number = ref.number, number_domain = ref.number_domain, pin = ref.pin;
      if (!((number != null) && (number_domain != null) && (pin != null) && typeof number === 'string' && typeof number_domain === 'string' && typeof pin === 'string')) {
        this.res.status(400);
        this.json({
          error: 'Invalid parameters',
          parameters: this.body
        });
        return;
      }
      debug('before translation', {
        number: number,
        number_domain: number_domain
      });
      new_number = (yield (typeof this.translate_local_number === "function" ? this.translate_local_number(number, number_domain) : void 0));
      if (new_number != null) {
        number = new_number;
      }
      debug('after translation', {
        number: number,
        number_domain: number_domain
      });
      user_id = number + "@" + number_domain;
      number_data = (yield this.cfg.prov.get("number:" + user_id)["catch"](function(error) {
        return {};
      }).then(function(data) {
        if (data != null ? data.disabled : void 0) {
          return {};
        } else {
          return data;
        }
      }));
      if ((number_data != null ? number_data._id : void 0) == null) {
        debug('No _id in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      user_database = number_data.user_database;
      if (user_database == null) {
        debug('No user_database in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      db_uri = this.cfg.userdb_base_uri + '/' + user_database;
      vm_db = new PouchDB(db_uri);
      vm_settings = (yield vm_db.get('voicemail_settings')["catch"](function(error) {
        return {};
      }));
      yield vm_db.close();
      if (!((vm_settings.pin != null) && vm_settings.pin === pin)) {
        this.res.status(404).end();
      }
      this.session.couchdb_username = user_id;
      this.session.couchdb_roles = ["number:" + user_id, "user_database:" + user_database];
      this.session.full_name = user_id;
      this.session.couchdb_token = hex_hmac_sha1(this.cfg.couchdb_secret, this.session.couchdb_username);
      return this.json({
        ok: true,
        username: this.session.couchdb_username,
        roles: this.session.couchdb_roles
      });
    }));
  };

  crypto = require('crypto');

  hex_hmac_sha1 = function(key, value) {
    var hmac;
    hmac = crypto.createHmac('sha1', key);
    hmac.update(value);
    return hmac.digest('hex');
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0tYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZtLWF1dGguY29mZmVlLm1kIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBSTtBQUFBLE1BQUE7O0VBQUEsSUFBQSxHQUFPLE9BQUEsQ0FBUSxNQUFSOztFQUNQLE9BQUEsR0FBVSxPQUFBLENBQVEsY0FBUixDQUNSLENBQUMsTUFETyxDQUNBLE9BQUEsQ0FBUSxzQkFBUixDQURBOztFQUVWLFFBQUEsR0FBVyxDQUFDLE9BQUEsQ0FBUSxhQUFSLENBQUQsQ0FBdUIsQ0FBQyxJQUF4QixDQUE2QixFQUE3Qjs7RUFFWCxJQUFDLENBQUEsSUFBRCxHQUFXLENBQUMsT0FBQSxDQUFRLFdBQVIsQ0FBRCxDQUFxQixDQUFDLElBQXZCLEdBQTRCOztFQUN0QyxLQUFBLEdBQVMsQ0FBQyxPQUFBLENBQVEsT0FBUixDQUFELENBQUEsQ0FBa0IsSUFBQyxDQUFBLElBQW5COztFQUVULElBQUMsQ0FBQSxPQUFELEdBQVcsU0FBQTtXQUtULElBQUMsQ0FBQSxJQUFELENBQU0sVUFBTixFQUFrQixRQUFsQixFQUE0QixJQUFBLENBQUssVUFBQTtBQUUvQixVQUFBO01BQUEsSUFBRyxrQ0FBSDtRQUNFLElBQUMsQ0FBQSxHQUFHLENBQUMsTUFBTCxDQUFZLEdBQVo7UUFDQSxJQUFDLENBQUEsSUFBRCxDQUFNO1VBQUEsS0FBQSxFQUFNLHVCQUFOO1NBQU47QUFDQSxlQUhGOztNQU9BLE1BQTZCLElBQUMsQ0FBQSxJQUE5QixFQUFDLG1CQUFELEVBQVEsaUNBQVIsRUFBc0I7TUFJdEIsSUFBQSxDQUFBLENBQU8sZ0JBQUEsSUFBWSx1QkFBWixJQUErQixhQUEvQixJQUNILE9BQU8sTUFBUCxLQUFpQixRQURkLElBRUgsT0FBTyxhQUFQLEtBQXdCLFFBRnJCLElBR0gsT0FBTyxHQUFQLEtBQWMsUUFIbEIsQ0FBQTtRQUlFLElBQUMsQ0FBQSxHQUFHLENBQUMsTUFBTCxDQUFZLEdBQVo7UUFDQSxJQUFDLENB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Q0FBWSxLQUFaO1dBQ0EsSUFBSSxDQUFDLE1BQUwsQ0FBWSxLQUFaO0VBSGM7QUF6R2hCIiwic291cmNlc0NvbnRlbnQiOlsiICAgIHNlZW0gPSByZXF1aXJlICdzZWVtJ1xuICAgIFBvdWNoREIgPSByZXF1aXJlICdwb3VjaGRiLWNvcmUnXG4gICAgICAucGx1Z2luIHJlcXVpcmUgJ3BvdWNoZGItYWRhcHRlci1odHRwJ1xuICAgIGpzb25Cb2R5ID0gKHJlcXVpcmUgJ2JvZHktcGFyc2VyJykuanNvbiB7fVxuXG4gICAgQG5hbWUgPSBcIiN7KHJlcXVpcmUgJy4vcGFja2FnZScpLm5hbWV9OnZtLWF1dGhcIlxuICAgIGRlYnVnICA9IChyZXF1aXJlICdkZWJ1ZycpIEBuYW1lXG5cbiAgICBAaW5jbHVkZSA9IC0+XG5cbkF1dGhlbnRpY2F0ZSB1c2luZyBudW1iZXIgYW5kIHZvaWNlbWFpbCBQSU5cbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgICAgQHBvc3QgJy92bS1hdXRoJywganNvbkJvZHksIHNlZW0gLT5cblxuICAgICAgICBpZiBAc2Vzc2lvbi5jb3VjaGRiX3Rva2VuP1xuICAgICAgICAgIEByZXMuc3RhdHVzIDQwMFxuICAgICAgICAgIEBqc29uIGVycm9yOidBbHJlYWR5IGF1dGhlbnRpY2F0ZWQnXG4gICAgICAgICAgcmV0dXJuXG5cblNlZSB3ZWxsLWdyb29tZWQtZmVhc3Qvc3JjL01lc3NhZ2luZy5jb2ZmZWUubWQgZm9yIHRoZSBwcm9jZXNzXG5cbiAgICAgICAge251bWJlcixudW1iZXJfZG9tYWluLHBpbn0gPSBAYm9keVxuXG5FbnN1cmUgYWxsIHBhcmFtZXRlcnMgYXJlIHByZXNlbnRcblxuICAgICAgICB1bmxlc3MgbnVtYmVyPyBhbmQgbnVtYmVyX2RvbWFpbj8gYW5kIHBpbj8gIGFuZFxuICAgICAgICAgICAgdHlwZW9mIG51bWJlciBpcyAnc3RyaW5nJyBhbmRcbiAgICAgICAgICAgIHR5cGVvZiBudW1iZXJfZG9tYWluIGlzICdzdHJpbmcnIGFuZFxuICAgICAgICAgICAgdHlwZW9mIHBpbiBpcyAnc3RyaW5nJ1xuICAgICAgICAgIEByZXMuc3RhdHVzIDQwMFxuICAgICAgICAgIEBqc29uIGVycm9yOidJbnZhbGlkIHBhcmFtZXRlcnMnLCBwYXJhbWV0ZXJzOiBAYm9keVxuICAgICAgICAgIHJldHVyblxuXG5UcmFuc2xhdGUgdGhlIGxvY2FsIG51bWJlclxuXG4gICAgICAgIGRlYnVnICdiZWZvcmUgdHJhbnNsYXRpb24nLCB7bnVtYmVyLG51bWJlcl9kb21haW59XG5cbiAgICAgICAgbmV3X251bWJlciA9IHlpZWxkIEB0cmFuc2xhdGVfbG9jYWxfbnVtYmVyPyBudW1iZXIsIG51bWJlcl9kb21haW5cbiAgICAgICAgbnVtYmVyID0gbmV3X251bWJlciBpZiBuZXdfbnVtYmVyP1xuXG4gICAgICAgIGRlYnVnICdhZnRlciB0cmFuc2xhdGlvbicsIHtudW1iZXIsbnVtYmVyX2RvbWFpbn1cblxuICAgICAgICB1c2VyX2lkID0gXCIje251bWJlcn1AI3tudW1iZXJfZG9tYWlufVwiXG5cbiAgICAgICAgbnVtYmVyX2RhdGEgPSB5aWVsZCBAY2ZnLnByb3ZcbiAgICAgICAgICAuZ2V0IFwibnVtYmVyOiN7dXNlcl9pZH1cIlxuICAgICAgICAgIC5jYXRjaCAoZXJyb3IpIC0+XG4gICAgICAgICAgICB7fVxuICAgICAgICAgIC50aGVuIChkYXRhKSAtPlxuICAgICAgICAgICAgaWYgZGF0YT8uZGlzYWJsZWQgdGhlbiB7fSBlbHNlIGRhdGFcblxuICAgICAgICB1bmxlc3MgbnVtYmVyX2RhdGE/Ll9pZD9cbiAgICAgICAgICBkZWJ1ZyAnTm8gX2lkIGluJywge251bWJlcl9kYXRhfVxuICAgICAgICAgIEByZXNcbiAgICAgICAgICAgIC5zdGF0dXMgNDA0XG4gICAgICAgICAgICAuZW5kKClcbiAgICAgICAgICByZXR1cm5cblxuUmV0cmlldmUgdGhlIHVzZXIgZGF0YWJhc2VcblxuICAgICAgICB7dXNlcl9kYXRhYmFzZX0gPSBudW1iZXJfZGF0YVxuXG4gICAgICAgIHVubGVzcyB1c2VyX2RhdGFiYXNlP1xuICAgICAgICAgIGRlYnVnICdObyB1c2VyX2RhdGFiYXNlIGluJywge251bWJlcl9kYXRhfVxuICAgICAgICAgIEByZXNcbiAgICAgICAgICAgIC5zdGF0dXMgNDA0XG4gICAgICAgICAgICAuZW5kKClcbiAgICAgICAgICByZXR1cm5cblxuUmV0cmlldmUgdGhlIHZvaWNlbWFpbC1zZXR0aW5ncyBkb2N1bWVudFxuXG4gICAgICAgIGRiX3VyaSA9IEBjZmcudXNlcmRiX2Jhc2VfdXJpICsgJy8nICsgdXNlcl9kYXRhYmFzZVxuICAgICAgICB2bV9kYiA9IG5ldyBQb3VjaERCIGRiX3VyaVxuXG4gICAgICAgIHZtX3NldHRpbmdzID0geWllbGQgdm1fZGJcbiAgICAgICAgICAuZ2V0ICd2b2ljZW1haWxfc2V0dGluZ3MnXG4gICAgICAgICAgLmNhdGNoIChlcnJvcikgLT5cbiAgICAgICAgICAgIHt9XG5cbiAgICAgICAgeWllbGQgdm1fZGIuY2xvc2UoKVxuXG5WYWxpZGF0ZSB0aGUgUElOXG5cbiAgICAgICAgdW5sZXNzIHZtX3NldHRpbmdzLnBpbj8gYW5kIHZtX3NldHRpbmdzLnBpbiBpcyBwaW5cbiAgICAgICAgICBAcmVzXG4gICAgICAgICAgICAuc3RhdHVzIDQwNFxuICAgICAgICAgICAgLmVuZCgpXG5cbkF1dGhlbnRpY2F0ZWQgT0tcblxuICAgICAgICBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lID0gdXNlcl9pZFxuICAgICAgICBAc2Vzc2lvbi5jb3VjaGRiX3JvbGVzID0gW1xuICAgICAgICAgIFwibnVtYmVyOiN7dXNlcl9pZH1cIlxuICAgICAgICAgIFwidXNlcl9kYXRhYmFzZToje3VzZXJfZGF0YWJhc2V9XCJcbiAgICAgICAgXVxuICAgICAgICBAc2Vzc2lvbi5mdWxsX25hbWUgPSB1c2VyX2lkXG4gICAgICAgIEBzZXNzaW9uLmNvdWNoZGJfdG9rZW4gPSBoZXhfaG1hY19zaGExIEBjZmcuY291Y2hkYl9zZWNyZXQsIEBzZXNzaW9uLmNvdWNoZGJfdXNlcm5hbWVcblxuICAgICAgICBAanNvblxuICAgICAgICAgIG9rOnRydWVcbiAgICAgICAgICB1c2VybmFtZTogQHNlc3Npb24uY291Y2hkYl91c2VybmFtZVxuICAgICAgICAgIHJvbGVzOiBAc2Vzc2lvbi5jb3VjaGRiX3JvbGVzXG5cbiAgICBjcnlwdG8gPSByZXF1aXJlICdjcnlwdG8nXG4gICAgaGV4X2htYWNfc2hhMSA9IChrZXksdmFsdWUpIC0+XG4gICAgICBobWFjID0gY3J5cHRvLmNyZWF0ZUhtYWMgJ3NoYTEnLCBrZXlcbiAgICAgIGhtYWMudXBkYXRlIHZhbHVlXG4gICAgICBobWFjLmRpZ2VzdCAnaGV4J1xuIl19
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/spicy-action-user/vm-auth.coffee.md