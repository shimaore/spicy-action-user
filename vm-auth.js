// Generated by CoffeeScript 1.12.7
(function() {
  var PouchDB, crypto, debug, hex_hmac_sha1, jsonBody, seem;

  seem = require('seem');

  PouchDB = require('ccnq4-pouchdb');

  jsonBody = (require('body-parser')).json({});

  this.name = (require('./package')).name + ":vm-auth";

  debug = (require('debug'))(this.name);

  this.include = function() {
    return this.post('/vm-auth', jsonBody, seem(function*() {
      var db_uri, new_number, number, number_data, number_domain, pin, ref, user_database, user_id, vm_db, vm_settings;
      if (this.session.couchdb_token != null) {
        this.res.status(400);
        this.json({
          error: 'Already authenticated'
        });
        return;
      }
      ref = this.body, number = ref.number, number_domain = ref.number_domain, pin = ref.pin;
      if (!((number != null) && (number_domain != null) && (pin != null) && typeof number === 'string' && typeof number_domain === 'string' && typeof pin === 'string')) {
        this.res.status(400);
        this.json({
          error: 'Invalid parameters',
          parameters: this.body
        });
        return;
      }
      debug('before translation', {
        number: number,
        number_domain: number_domain
      });
      new_number = (yield (typeof this.translate_local_number === "function" ? this.translate_local_number(number, number_domain) : void 0));
      if (new_number != null) {
        number = new_number;
      }
      debug('after translation', {
        number: number,
        number_domain: number_domain
      });
      user_id = number + "@" + number_domain;
      number_data = (yield this.cfg.prov.get("number:" + user_id)["catch"](function(error) {
        return {};
      }).then(function(data) {
        if (data != null ? data.disabled : void 0) {
          return {};
        } else {
          return data;
        }
      }));
      if ((number_data != null ? number_data._id : void 0) == null) {
        debug('No _id in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      user_database = number_data.user_database;
      if (user_database == null) {
        debug('No user_database in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      db_uri = this.cfg.userdb_base_uri + '/' + user_database;
      vm_db = new PouchDB(db_uri);
      vm_settings = (yield vm_db.get('voicemail_settings')["catch"](function(error) {
        return {};
      }));
      yield vm_db.close();
      if (!((vm_settings.pin != null) && vm_settings.pin === pin)) {
        this.res.status(404).end();
      }
      this.session.couchdb_username = user_id;
      this.session.couchdb_roles = ["number:" + user_id, "user_database:" + user_database];
      this.session.full_name = user_id;
      this.session.couchdb_token = hex_hmac_sha1(this.cfg.couchdb_secret, this.session.couchdb_username);
      return this.json({
        ok: true,
        username: this.session.couchdb_username,
        roles: this.session.couchdb_roles
      });
    }));
  };

  crypto = require('crypto');

  hex_hmac_sha1 = function(key, value) {
    var hmac;
    hmac = crypto.createHmac('sha1', key);
    hmac.update(value);
    return hmac.digest('hex');
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0tYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZtLWF1dGguY29mZmVlLm1kIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBSTtBQUFBLE1BQUE7O0VBQUEsSUFBQSxHQUFPLE9BQUEsQ0FBUSxNQUFSOztFQUNQLE9BQUEsR0FBVSxPQUFBLENBQVEsZUFBUjs7RUFDVixRQUFBLEdBQVcsQ0FBQyxPQUFBLENBQVEsYUFBUixDQUFELENBQXVCLENBQUMsSUFBeEIsQ0FBNkIsRUFBN0I7O0VBRVgsSUFBQyxDQUFBLElBQUQsR0FBVyxDQUFDLE9BQUEsQ0FBUSxXQUFSLENBQUQsQ0FBcUIsQ0FBQyxJQUF2QixHQUE0Qjs7RUFDdEMsS0FBQSxHQUFTLENBQUMsT0FBQSxDQUFRLE9BQVIsQ0FBRCxDQUFBLENBQWtCLElBQUMsQ0FBQSxJQUFuQjs7RUFFVCxJQUFDLENBQUEsT0FBRCxHQUFXLFNBQUE7V0FLVCxJQUFDLENBQUEsSUFBRCxDQUFNLFVBQU4sRUFBa0IsUUFBbEIsRUFBNEIsSUFBQSxDQUFLLFVBQUE7QUFFL0IsVUFBQTtNQUFBLElBQUcsa0NBQUg7UUFDRSxJQUFDLENBQUEsR0FBRyxDQUFDLE1BQUwsQ0FBWSxHQUFaO1FBQ0EsSUFBQyxDQUFBLElBQUQsQ0FBTTtVQUFBLEtBQUEsRUFBTSx1QkFBTjtTQUFOO0FBQ0EsZUFIRjs7TUFPQSxNQUE2QixJQUFDLENBQUEsSUFBOUIsRUFBQyxtQkFBRCxFQUFRLGlDQUFSLEVBQXNCO01BSXRCLElBQUEsQ0FBQSxDQUFPLGdCQUFBLElBQVksdUJBQVosSUFBK0IsYUFBL0IsSUFDSCxPQUFPLE1BQVAsS0FBaUIsUUFEZCxJQUVILE9BQU8sYUFBUCxLQUF3QixRQUZyQixJQUdILE9BQU8sR0FBUCxLQUFjLFFBSGxCLENBQUE7UUFJRSxJQUFDLENBQUEsR0FBRyxDQUFDLE1BQUwsQ0FBWSxHQUFaO1FBQ0EsSUFBQyxDQUFBLElBQUQsQ0FBTTtVQUFBLEtBQUEsRUFBTSxvQkFBTjtVQUE0QixV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QUhjO0FBeEdoQiIsInNvdXJjZXNDb250ZW50IjpbIiAgICBzZWVtID0gcmVxdWlyZSAnc2VlbSdcbiAgICBQb3VjaERCID0gcmVxdWlyZSAnY2NucTQtcG91Y2hkYidcbiAgICBqc29uQm9keSA9IChyZXF1aXJlICdib2R5LXBhcnNlcicpLmpzb24ge31cblxuICAgIEBuYW1lID0gXCIjeyhyZXF1aXJlICcuL3BhY2thZ2UnKS5uYW1lfTp2bS1hdXRoXCJcbiAgICBkZWJ1ZyAgPSAocmVxdWlyZSAnZGVidWcnKSBAbmFtZVxuXG4gICAgQGluY2x1ZGUgPSAtPlxuXG5BdXRoZW50aWNhdGUgdXNpbmcgbnVtYmVyIGFuZCB2b2ljZW1haWwgUElOXG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAgIEBwb3N0ICcvdm0tYXV0aCcsIGpzb25Cb2R5LCBzZWVtIC0+XG5cbiAgICAgICAgaWYgQHNlc3Npb24uY291Y2hkYl90b2tlbj9cbiAgICAgICAgICBAcmVzLnN0YXR1cyA0MDBcbiAgICAgICAgICBAanNvbiBlcnJvcjonQWxyZWFkeSBhdXRoZW50aWNhdGVkJ1xuICAgICAgICAgIHJldHVyblxuXG5TZWUgd2VsbC1ncm9vbWVkLWZlYXN0L3NyYy9NZXNzYWdpbmcuY29mZmVlLm1kIGZvciB0aGUgcHJvY2Vzc1xuXG4gICAgICAgIHtudW1iZXIsbnVtYmVyX2RvbWFpbixwaW59ID0gQGJvZHlcblxuRW5zdXJlIGFsbCBwYXJhbWV0ZXJzIGFyZSBwcmVzZW50XG5cbiAgICAgICAgdW5sZXNzIG51bWJlcj8gYW5kIG51bWJlcl9kb21haW4/IGFuZCBwaW4/ICBhbmRcbiAgICAgICAgICAgIHR5cGVvZiBudW1iZXIgaXMgJ3N0cmluZycgYW5kXG4gICAgICAgICAgICB0eXBlb2YgbnVtYmVyX2RvbWFpbiBpcyAnc3RyaW5nJyBhbmRcbiAgICAgICAgICAgIHR5cGVvZiBwaW4gaXMgJ3N0cmluZydcbiAgICAgICAgICBAcmVzLnN0YXR1cyA0MDBcbiAgICAgICAgICBAanNvbiBlcnJvcjonSW52YWxpZCBwYXJhbWV0ZXJzJywgcGFyYW1ldGVyczogQGJvZHlcbiAgICAgICAgICByZXR1cm5cblxuVHJhbnNsYXRlIHRoZSBsb2NhbCBudW1iZXJcblxuICAgICAgICBkZWJ1ZyAnYmVmb3JlIHRyYW5zbGF0aW9uJywge251bWJlcixudW1iZXJfZG9tYWlufVxuXG4gICAgICAgIG5ld19udW1iZXIgPSB5aWVsZCBAdHJhbnNsYXRlX2xvY2FsX251bWJlcj8gbnVtYmVyLCBudW1iZXJfZG9tYWluXG4gICAgICAgIG51bWJlciA9IG5ld19udW1iZXIgaWYgbmV3X251bWJlcj9cblxuICAgICAgICBkZWJ1ZyAnYWZ0ZXIgdHJhbnNsYXRpb24nLCB7bnVtYmVyLG51bWJlcl9kb21haW59XG5cbiAgICAgICAgdXNlcl9pZCA9IFwiI3tudW1iZXJ9QCN7bnVtYmVyX2RvbWFpbn1cIlxuXG4gICAgICAgIG51bWJlcl9kYXRhID0geWllbGQgQGNmZy5wcm92XG4gICAgICAgICAgLmdldCBcIm51bWJlcjoje3VzZXJfaWR9XCJcbiAgICAgICAgICAuY2F0Y2ggKGVycm9yKSAtPlxuICAgICAgICAgICAge31cbiAgICAgICAgICAudGhlbiAoZGF0YSkgLT5cbiAgICAgICAgICAgIGlmIGRhdGE/LmRpc2FibGVkIHRoZW4ge30gZWxzZSBkYXRhXG5cbiAgICAgICAgdW5sZXNzIG51bWJlcl9kYXRhPy5faWQ/XG4gICAgICAgICAgZGVidWcgJ05vIF9pZCBpbicsIHtudW1iZXJfZGF0YX1cbiAgICAgICAgICBAcmVzXG4gICAgICAgICAgICAuc3RhdHVzIDQwNFxuICAgICAgICAgICAgLmVuZCgpXG4gICAgICAgICAgcmV0dXJuXG5cblJldHJpZXZlIHRoZSB1c2VyIGRhdGFiYXNlXG5cbiAgICAgICAge3VzZXJfZGF0YWJhc2V9ID0gbnVtYmVyX2RhdGFcblxuICAgICAgICB1bmxlc3MgdXNlcl9kYXRhYmFzZT9cbiAgICAgICAgICBkZWJ1ZyAnTm8gdXNlcl9kYXRhYmFzZSBpbicsIHtudW1iZXJfZGF0YX1cbiAgICAgICAgICBAcmVzXG4gICAgICAgICAgICAuc3RhdHVzIDQwNFxuICAgICAgICAgICAgLmVuZCgpXG4gICAgICAgICAgcmV0dXJuXG5cblJldHJpZXZlIHRoZSB2b2ljZW1haWwtc2V0dGluZ3MgZG9jdW1lbnRcblxuICAgICAgICBkYl91cmkgPSBAY2ZnLnVzZXJkYl9iYXNlX3VyaSArICcvJyArIHVzZXJfZGF0YWJhc2VcbiAgICAgICAgdm1fZGIgPSBuZXcgUG91Y2hEQiBkYl91cmlcblxuICAgICAgICB2bV9zZXR0aW5ncyA9IHlpZWxkIHZtX2RiXG4gICAgICAgICAgLmdldCAndm9pY2VtYWlsX3NldHRpbmdzJ1xuICAgICAgICAgIC5jYXRjaCAoZXJyb3IpIC0+XG4gICAgICAgICAgICB7fVxuXG4gICAgICAgIHlpZWxkIHZtX2RiLmNsb3NlKClcblxuVmFsaWRhdGUgdGhlIFBJTlxuXG4gICAgICAgIHVubGVzcyB2bV9zZXR0aW5ncy5waW4/IGFuZCB2bV9zZXR0aW5ncy5waW4gaXMgcGluXG4gICAgICAgICAgQHJlc1xuICAgICAgICAgICAgLnN0YXR1cyA0MDRcbiAgICAgICAgICAgIC5lbmQoKVxuXG5BdXRoZW50aWNhdGVkIE9LXG5cbiAgICAgICAgQHNlc3Npb24uY291Y2hkYl91c2VybmFtZSA9IHVzZXJfaWRcbiAgICAgICAgQHNlc3Npb24uY291Y2hkYl9yb2xlcyA9IFtcbiAgICAgICAgICBcIm51bWJlcjoje3VzZXJfaWR9XCJcbiAgICAgICAgICBcInVzZXJfZGF0YWJhc2U6I3t1c2VyX2RhdGFiYXNlfVwiXG4gICAgICAgIF1cbiAgICAgICAgQHNlc3Npb24uZnVsbF9uYW1lID0gdXNlcl9pZFxuICAgICAgICBAc2Vzc2lvbi5jb3VjaGRiX3Rva2VuID0gaGV4X2htYWNfc2hhMSBAY2ZnLmNvdWNoZGJfc2VjcmV0LCBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lXG5cbiAgICAgICAgQGpzb25cbiAgICAgICAgICBvazp0cnVlXG4gICAgICAgICAgdXNlcm5hbWU6IEBzZXNzaW9uLmNvdWNoZGJfdXNlcm5hbWVcbiAgICAgICAgICByb2xlczogQHNlc3Npb24uY291Y2hkYl9yb2xlc1xuXG4gICAgY3J5cHRvID0gcmVxdWlyZSAnY3J5cHRvJ1xuICAgIGhleF9obWFjX3NoYTEgPSAoa2V5LHZhbHVlKSAtPlxuICAgICAgaG1hYyA9IGNyeXB0by5jcmVhdGVIbWFjICdzaGExJywga2V5XG4gICAgICBobWFjLnVwZGF0ZSB2YWx1ZVxuICAgICAgaG1hYy5kaWdlc3QgJ2hleCdcbiJdfQ==
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/spicy-action-user/vm-auth.coffee.md